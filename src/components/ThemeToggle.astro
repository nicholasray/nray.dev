---
import { Icon } from "astro-icon";
---

<theme-toggle>
  <button
    class="block rounded-full p-3 hover:bg-zinc-100 dark:hover:bg-zinc-800 dark:hover:text-white"
  >
    <div class="theme-toggle-light dark:hidden">
      <Icon class="h-6 md:h-7" name="ph:sun" />
      <span class="sr-only">Toggle Dark Mode</span>
    </div>
    <div class="theme-toggle-dark hidden dark:block">
      <Icon class="h-6 md:h-7" name="ph:moon" />
      <span class="sr-only">Toggle Light Mode</span>
    </div>
  </button>
</theme-toggle>

<script>
  class ThemeToggle extends HTMLElement {
    meta: HTMLMetaElement;

    constructor() {
      super();

      this.handleSystemChange = this.handleSystemChange.bind(this);
      this.meta = document.head.querySelector(
        'meta[name="theme-color"]'
      ) as HTMLMetaElement;
      const button = this.querySelector("button") as HTMLElement;
      const mediaQueryList = window.matchMedia("(prefers-color-scheme: dark)");

      // Handle system theme changes.
      if (mediaQueryList.addEventListener) {
        mediaQueryList.addEventListener("change", this.handleSystemChange);
      } else {
        mediaQueryList.addListener(this.handleSystemChange);
      }

      // Handle theme toggle button clicks.
      button.addEventListener("click", () => {
        const isDark = document.documentElement.classList.contains("dark");

        if (isDark) {
          this.enableLightMode();
        } else {
          this.enableDarkMode();
        }
      });
    }

    handleSystemChange(e: MediaQueryListEvent) {
      if (e.matches) {
        this.enableDarkMode();
      } else {
        this.enableLightMode();
      }
    }

    toggleMeta() {
      const next = this.meta.dataset.next;
      this.meta.dataset.next = this.meta.content;
      if (next) {
        this.meta.content = next;
      }
    }

    enableLightMode() {
      document.documentElement.classList.remove("dark");
      localStorage.setItem("theme", "light");
      this.toggleMeta();
    }

    enableDarkMode() {
      document.documentElement.classList.add("dark");
      localStorage.setItem("theme", "dark");
      this.toggleMeta();
    }
  }

  customElements.define("theme-toggle", ThemeToggle);
</script>
